## File Hash & VT Analysis

24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c *Ransomware.wannacry.exe.malz

db349b97c37d22f5ea1d1841e3c89eb4 *Ransomware.wannacry.exe.malz

VT Analysis: 68/71 Infected

## Basic Static Analysis

### Strings & floss output

The binary is using cmd to run some command. There is one interesting file tasksche.exe I found it is a malicious program packed with wannacry. It is also executing icals to change the share permissions. And a string "WNcry@2o17" 

![bcddf4f0187970198ad644a21f60c1b5.png](:/a2b10b079fbd47e788a28f53246db0cf)

The binary is shaving the share paths of some machines

![af7ac737b7bc0ef6886a2c76062a25af.png](:/69a254cba69a4941ab3c8570e9bfd01c)

It is has a path in C dir which looks interesting

![760b3a5c5b4732acfdf66520d6890c14.png](:/cea9905bdab54232a312eb204634ee57)

Various language packages 

![5786c45af90efa3273953193db6ba4c4.png](:/345ec5cc91c04ec4b24bb31b803869ee)

### IAT & PE view

#### Windows API calls

InternetOpenA
InternetOpenUrlA
CryptAcquireContextA
CryptGenRandom
rand
srand
ChangeServiceConfig2A
StartServiceCtrlDispathcerA
Lockit

## Basic Dynamic Analysis

### Initial Detonation

Wallpaper is changed

![9a1e7a3f9c0a6919c862cf9e08e227ab.png](:/ca8dd4df04ab4704b7901a1d8044296a)

After initial detonation we a window named wana decrypt0r 2.0 asking to pay to decrypt the files in the system. 

![8ab7181f5618af1fccb729eac0c24d77.png](:/ed129f18488941a49d64907cbf8822f1)

Most of the text, jpeg etc files are encrypted. Files are appended with `.WNCRY` extension after initial detonation.

![0fcb3a1446f0a7367c05562af3e62ac7.png](:/0336f2477920401f932d4fc8ac26fd6c)

In every directory we can see `wanadecrypt0r` and `@pleasereadme`

![ac10a2281cc5f07e038abf3f10f7c0fd.png](:/0facb5d64184470ea100cf302d15831b)

I also found out that there is a trigger condition with wannacry.  When we detonate the binary it makes a DNS query to the host `www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com` if the host is found the encryption routine is not executed otherwise the encryption routine is executed. This implies if inetsim is up then the encryption routine will not be executed.

![7e4cc084de4626a943158d17620273a8.png](:/d2726232c1e745858a6b5e763d246ff2)

![d818541839a8b41f13354234b427ddd9.png](:/b9eea395583f4359abaac67843efa576)

### Host Indicators

Wannacry has different binaries packed inside it, one of them is tasksche.exe. The tasksche.exe is responsible for creating a staging location, encryption and persistence.

![aa076d830ba92b4a46d11ad4a8e63a45.png](:/a7e2b3c81ea9489e99d53f42b8e4eea5)

We can see that Wannacry is spawning tasksche.exe as child process to perform the intended routines.

![678ff94e651722c0d96ed378784147fc.png](:/e32a7fb401ec4d59a15cf3c6e7984649)

And taskche.exe is creating a folder as staging space for the binary, creating persistence etc by running attrib, icacls and cscript.

![74fb81faf0090097ce87f52657fff05a.png](:/20905eddf12242a9b5ad9b3807c38607)

This dir is created by tasksche and used as a staging space for wannacry further inspecting the dir we can find supporting evidences.

![4a44e36b7f826fdf109579f899aa15a2.png](:/3c87564de987451ba2462914b6cf1770)

Hidden dir is created using attrib

![a818ad5d20a9c87d92857211764f895d.png](:/081c8d024c2e4ee1bf7d018300d403c2)

![66df164f88a12689938df8520795afe8.png](:/155100466ac042a3bbfa9fec058f5035)

Wannacry creates a malicious service on the victim machine. Using this malicious service it establishes persistence on the victim.

![16e719fa40515a8fd53a49c6656de129.png](:/a81a6d9af43e4accb3665a1afcb5eb5f)

### Network Signatures

Right after detonating the binary we can see the victim machine is sending TCP SYN packets to the machines in the network on port 445. This is because wannacry uses eternal blue exploit to spread itself across the network.

![a7bd60f244a80dcac9dca982d78998e5.png](:/c76026cf9f1242ff93a2743810999eff)

## Advanced Static Analysis

Analyzing the code in de-compiler we can see the binary is loading the interesting host at the very beginning. It is opening a URL handle to load and moving the binary to variable edi. Then it is copying the same value to eax. After that it is using test instruction on edi register. The value retuned by test instruction is used by the jne statement. Basically if the URL is successfully opened then the jump statements is executed and the encryption routine is not executed and finally the program is exits. And if the URL is not successfully executed then vice-versa. 

![cc124a992f0801e4f6b9347af6a67b5b.png](:/3285a51c32ee4ee6afe8c8769f99ec98)

![6d935e4b3743c8d0a6ed652f562260ac.png](:/3a63910bb5414e77b325740e887925d0)

## Summary

- The encryption routine will only execute if the host `iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com` is not reachable.
- The main binary spawns a child process tasksche.exe to perform the various stages like gaining persistence, lateral movement, encrypting the victim files etc.
